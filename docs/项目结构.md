# 项目结构总览

本项目用于从飞书拉取合同相关数据，并将历史合同数据按映射规则转换为新系统的导入模板。

## 目录树（当前）

```
飞书合同拉取合同数据/
├── README.md
├── requirements.txt
├── config/
│   ├── settings.yaml
│   └── settings.example.yaml
├── feishu_contracts/
│   ├── __init__.py
│   ├── cli.py
│   ├── common/
│   │   ├── __init__.py
│   │   ├── config.py
│   │   ├── logging.py
│   │   └── paths.py
│   ├── convert/
│   │   ├── __init__.py
│   │   └── jsonl_to_tabular.py
│   ├── fetch/
│   │   ├── __init__.py
│   │   └── client.py
│   └── transform/
│       ├── __init__.py
│       ├── transformer.py
│       ├── validators.py
│       └── mapping.yaml
├── scripts/
│   ├── run_full_pipeline.py
│   ├── run_jsonl_convert.py
│   └── run_transform.py
├── data/
│   ├── raw/
│   │   ├── .gitkeep
│   │   └── 合同编码清单.txt
│   ├── interim/
│   │   └── .gitkeep
│   └── processed/
│       ├── .gitkeep
│       └── contracts1.xlsx   # 历史样例（可选择保留）
├── output/
│   └── .gitkeep
├── logs/
│   └── .gitkeep
├── templates/
│   └── 合同导入模板.xlsx
├── docs/
│   ├── README.md
│   ├── 项目结构.md
│   ├── 设计方案.md
│   ├── 搜索合同.md
│   └── 查看合同详情.md
├── tests/
│   ├── test_jsonl_converter.py
│   └── test_transformer.py
└── （无根目录脚本；抓取与转换均在包内模块与 scripts/ 下实现）
```

## 关键模块说明

- `feishu_contracts/`
  - `cli.py`：命令行入口（支持使用 `config/settings.yaml` 默认值）。
  - `common/`：通用设施
    - `config.py`：统一配置加载、路径解析工具。
    - `logging.py`：统一日志（旋转、格式）。
    - `paths.py`：路径工具。
  - `convert/`：转换工具
    - `jsonl_to_tabular.py`：JSONL → CSV/Excel 的转换（由根目录迁移）。
  - `fetch/`：抓取模块
    - `client.py`：令牌管理、搜索/详情抓取、并发与限流、`run_fetch()` 主流程。
  - `transform/`：转换模块，按配置驱动（`mapping.yaml`）对多 Sheet 数据进行映射与校验。
    - `transformer.py`：核心转换逻辑，读取源数据并填充导入模板。
    - `validators.py`：字段/规则校验与审计支持。
    - `mapping.yaml`：字段/Sheet 映射配置，支持行策略与多表关联。
（无根目录脚本项，统一通过 `scripts/` 与包内模块调用）
- 数据与产出
  - `data/raw/`：抓取的 JSONL、清单等原始数据。
  - `data/processed/`：转换后的 CSV/Excel 中间数据。
  - `output/`：最终导入模板产出目录。
  - `templates/合同导入模板.xlsx`：标准导入底稿模板。
- 文档
  - `docs/`：项目说明、设计方案与操作记录。
- 其他
  - 系统/临时文件（`.DS_Store`、`~$*.xlsx`）已纳入忽略。

## 依赖

- `requirements.txt`
  - pandas>=1.5,<3
  - openpyxl>=3.1
  - PyYAML>=6.0

## 运行命令（示例）

- 全流程（一键）：
  - `python scripts/run_full_pipeline.py --config config/settings.yaml`

- 分步执行：
  - JSONL→CSV/Excel：`python scripts/run_jsonl_convert.py --config config/settings.yaml`
  - Excel（多Sheet）→导入模板：
    - `python scripts/run_transform.py --config config/settings.yaml`
    - 或包内 CLI：`python -m feishu_contracts.cli --config config/settings.yaml`

注：CLI 显式参数将覆盖 `config/settings.yaml` 中的默认值。
