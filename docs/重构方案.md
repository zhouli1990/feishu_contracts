# 重构方案（v1 提案）

> 目标：在不改变业务功能与对外行为的前提下，理顺目录结构、统一配置与日志、消除脚本与库的耦合，提升可维护性与可测试性。

---

## 背景与边界
- **背景**：本仓库既包含抓取飞书合同数据的脚本，又包含将历史合同数据按 `mapping.yaml` 转换到导入模板的模块与脚本，存在“脚本与库混杂、配置解析分散、路径处理不统一”等典型可维护性问题。
- **已确认约束（不变更）**：
  - **仅使用 `config/settings.yaml` 管理配置**（不引入 `.env`）。
  - **不引入 `pyproject.toml`**（依赖以 `requirements.txt` 为准）。
  - **暂不引入 IO 输入输出适配层**（保持现有直连读写方式）。

---

## 现状评估与问题清单（含证据）
- **脚本与库代码混杂**：
  - `scripts/run_full_pipeline.py` 为调用编排，但直接 `import script as fetch_script` 并在运行前设置一组全局变量（第63-71行）。导致抓取实现与调用方通过“模块级全局变量”耦合，难测难复用。
  - `jsonl_converter.py` 位于项目根目录，与包内模块 `feishu_contracts/transform/*` 并列，不符合“库代码集中在包内”的惯例。
- **重复/分散的配置加载**：
  - `feishu_contracts/cli.py` 第19-35行自行读取 `settings.yaml`，`scripts/run_full_pipeline.py` 第30-35行重复实现，后续修改配置结构需要双处维护。
- **路径与导入方式不统一**：
  - `scripts/run_full_pipeline.py` 第8-14行通过修改 `sys.path` 注入工程根目录，属于脆弱式导入，且隐藏了包边界。
- **敏感信息明文提交**：
  - `config/settings.yaml` 第12-15行包含真实 `app_key/app_secret`，存在泄露风险（建议后续在仓库中改为示例文件，实际文件忽略提交）。
- **日志规范不统一**：
  - 仅 `run_full_pipeline.py` 配置了旋转文件日志；其它脚本/CLI缺少一致的日志设施，排障体验不一致。
- **命名与位置不一致**：
  - 转换模块在包内（`feishu_contracts/transform`），而抓取与转换脚本分散在根目录与 `scripts/`；对新人理解成本高。
- **测试覆盖不均衡**：
  - 现有测试集中在 `tests/test_jsonl_converter.py`、`tests/test_transformer.py`，缺少抓取流程与配置加载的单元测试。

---

## 重构目标（可量化）
- **结构清晰**：库代码集中于 `feishu_contracts/` 包内，脚本仅作薄封装（无业务逻辑）。
- **配置单一入口**：统一使用一个 `config_loader` 读取 `config/settings.yaml`，调用侧不再重复解析。
- **可测性提升**：抓取/转换提供纯函数或可注入依赖的薄类，移除模块级全局变量；测试覆盖新增到抓取与配置。
- **路径与日志统一**：统一 Path/日志初始化，去除 `sys.path` 注入；日志默认写入 `logs/*.log` 并控制大小轮转。
- **安全合规**：仓库仅保留 `settings.example.yaml`（模板），`settings.yaml` 加入 `.gitignore`，避免凭据提交。
- **兼容性保证**：保留原有 `scripts/*.py` 名称与 CLI 入口作为兼容层（调用新包 API），对外用法不变。

---

## 目标目录结构（提案）
```text
飞书合同拉取合同数据/
├─ README.md
├─ requirements.txt
├─ config/
│  ├─ settings.example.yaml      # 模板（提交到仓库）
│  └─ settings.yaml              # 本地实际文件（.gitignore）
├─ feishu_contracts/
│  ├─ __init__.py
│  ├─ cli.py                     # 统一 CLI（可含子命令 fetch/convert/transform）
│  ├─ common/
│  │  ├─ __init__.py
│  │  ├─ config.py               # 单一配置加载入口
│  │  ├─ logging.py              # 日志初始化（旋转文件）
│  │  └─ paths.py                # 路径工具、绝对/相对规范
│  ├─ fetch/
│  │  ├─ __init__.py
│  │  ├─ client.py               # 搜索/详情 API 封装、重试
│  │  └─ exporter.py             # 导出 JSONL/CSV/Excel 抽象
│  ├─ convert/
│  │  ├─ __init__.py
│  │  └─ jsonl_to_tabular.py     # 由原 root/jsonl_converter.py 迁入
│  └─ transform/
│     ├─ __init__.py
│     ├─ transformer.py
│     ├─ validators.py
│     └─ mapping.yaml
├─ scripts/
│  ├─ fetch_contracts.py         # 薄封装（调用 fetch.client + exporter）
│  ├─ convert_jsonl.py           # 薄封装（调用 convert.jsonl_to_tabular）
│  ├─ transform_template.py      # 薄封装（调用 transform.transformer）
│  └─ full_pipeline.py           # 现有 run_full_pipeline.py 重命名/兼容入口
├─ data/
│  ├─ raw/
│  ├─ interim/
│  └─ processed/
├─ templates/
├─ output/
├─ logs/
├─ docs/
└─ tests/
```

---

## 迁移步骤与风险控制
- **步骤1｜抽离配置加载（零影响）**
  - 新增 `feishu_contracts/common/config.py` 暴露 `load_settings(path) -> dict`；
  - `feishu_contracts/cli.py` 与 `scripts/run_full_pipeline.py` 改为依赖该函数；去除重复 YAML 解析；
  - 验证：现有 CLI、`run_full_pipeline.py` 均可读取配置并正常运行。

- **步骤2｜收拢转换/转换脚本与工具（低风险）**
  - 将根目录 `jsonl_converter.py` 移至 `feishu_contracts/convert/jsonl_to_tabular.py`；
  - 在 `scripts/run_jsonl_convert.py` 中改为包内导入；保留原命令行参数不变；
  - 验证：`python scripts/run_jsonl_convert.py` 行为不变，产物路径一致。

- **步骤3｜解耦抓取脚本的全局变量（中风险）**
  - 将 `script.py` 拆分为 `feishu_contracts/fetch/client.py`（API + 业务流程）与 `feishu_contracts/fetch/exporter.py`（CSV/Excel 输出策略）；
  - 所有原先通过模块全局变量注入的参数（如 `PAGE_SIZE/DETAIL_WORKERS/...`）改为函数参数或 `@dataclass Config`；
  - `scripts/run_full_pipeline.py` 与 `scripts/fetch_contracts.py` 改为传参式调用；
  - 验证：抓取速度、CSV/Excel 结果与日志行为与基线一致；大样本测试对比文件行数与关键列哈希。

- **步骤4｜统一日志初始化（零/低风险）**
  - 新增 `feishu_contracts/common/logging.py`，提供 `setup_logger(name, file)`；
  - CLI 与脚本在入口初始化，确保 `logs/*.log` 统一格式与轮转策略。

- **步骤5｜命令行与向后兼容（零风险）**
  - 保留现有 `scripts/run_*.py` 与 `python -m feishu_contracts.cli` 的用法；
  - 可选将 CLI 扩展为子命令：`feishu-contracts fetch|convert|transform`（不强制，保持现状亦可）。

- **步骤6｜安全整改（必要）**
  - 新增并提交 `config/settings.example.yaml`（不含敏感值）；
  - 将 `config/settings.yaml` 加入 `.gitignore` 并由开发者本地复制示例再填写；
  - 已提交的 `app_key/app_secret` 建议马上旋转；
  - 文档（`docs/README.md`）补充本地配置说明。

- **步骤7｜测试补齐（必要）**
  - 新增：`tests/test_config.py`（配置加载）、`tests/test_fetch.py`（mock/vcr 桩）、`tests/test_paths.py`；
  - 维持：`tests/test_jsonl_converter.py`、`tests/test_transformer.py`；
  - 引入轻量依赖：仅 `pytest`，不新增其它库。

---

## 兼容性策略
- 对外命令保持：
  - `python scripts/run_full_pipeline.py --config config/settings.yaml`
  - `python scripts/run_jsonl_convert.py --config config/settings.yaml`
  - `python scripts/run_transform.py --config config/settings.yaml`
  - `python -m feishu_contracts.cli --config config/settings.yaml`
- 若新增 `scripts/fetch_contracts.py`/重命名为 `full_pipeline.py`，保留旧脚本为薄包装并打印弃用提示。

---

## 验收标准（Definition of Done）
- 目录结构与本方案一致（或经评审达成的变体）；
- 无 `sys.path` 注入；库代码不依赖模块级全局变量传参；
- 所有脚本运行成功且产出路径/格式与重构前一致；
- 日志统一写入 `logs/*.log`，格式一致且轮转生效；
- `config/settings.yaml` 不再提交敏感凭据，示例文件齐备，README 有操作指引；
- 测试通过：`pytest -q`，新增用例覆盖率提升到关键路径（抓取/配置/路径工具）。

---

## 风险与回滚
- 主要风险：抓取流程拆分时潜在行为回归；
- 缓解：
  - 先抽象“对外可观测”的产物（文件内容/日志条目数）作为基线；
  - 拆分后做对比测试（行数、关键字段 checksum）；
- 回滚策略：保留 `refactor/` 分支与原脚本，出现问题可快速切回旧版脚本执行。

---

## 时间与分工（参考）
- 步骤1-2：0.5d（配置抽离与文件迁移）
- 步骤3：1.0d（抓取解耦与参数化）
- 步骤4：0.5d（日志统一）
- 步骤5：0.5d（兼容包装）
- 步骤6：0.5d（安全整改与文档）
- 步骤7：0.5d（测试补齐）

---

## 非目标（本轮不做）
- 不接入 `.env`/Secret Manager/IO 适配层；
- 不引入 `pyproject.toml` 或构建/发布流程；
- 不改动 `mapping.yaml` 语义与转换算法；
- 不改动接口调用策略（并发/重试参数除外）。

---

## 变更清单（草案）
- 新增：`feishu_contracts/common/{config.py,logging.py,paths.py}`；
- 迁移：`jsonl_converter.py` → `feishu_contracts/convert/jsonl_to_tabular.py`；
- 拆分：`script.py` → `feishu_contracts/fetch/{client.py,exporter.py}`；
- 脚本：新增 `scripts/fetch_contracts.py`，原 `run_*.py` 改为薄封装；
- 配置：新增并提交 `config/settings.example.yaml`，忽略 `config/settings.yaml`；
- 文档：更新 `README.md`/`docs/README.md` 增补配置说明与命令列表；
- 测试：新增 `tests/test_config.py`、`tests/test_fetch.py`、`tests/test_paths.py`。

---

## 附录：命名与代码规范（简）
- 模块/文件：`lower_snake_case`；类：`CapWords`；常量：`UPPER_SNAKE_CASE`；
- 函数参数优先、少用模块级全局；
- 日志统一：`%(asctime)s [%(levelname)s] %(message)s`，旋转 2MB×5 份；
- 路径统一使用 `pathlib`，配置中的相对路径相对仓库根目录解析。
