# 日志增强方案

## 背景与目标
- **可读**：批量抓取/转换时能看到实时进度、耗时、成功/失败与原因。
- **可定位**：出现限流/异常能快速定位到合同编码、尝试轮次、等待时长。
- **可筛选**：抓取、转换、流水线分日志输出，便于分别排查。
- **可实时**：控制台输出精简关键进度；文件日志保留详尽信息并轮转。

## 设计总览
- **配置驱动**：在 `config/settings.yaml` 新增 `logging` 段，统一控制级别、格式、轮转与进度频率。
- **新增模块**：`feishu_contracts/common/logging_config.py` 提供 `init_logging(cfg, proj_root)`，集中初始化日志。
- **分模块 Logger**：命名 logger：`pipeline`、`fetch`、`convert`、`transform`，分别写入各自日志文件并可选控制台输出。
- **双通道输出**：
  - 控制台（简版）：仅阶段、进度、合同编码等关键字段，便于实时观察。
  - 文件（详版/可选 JSON）：完整时间戳、级别、阶段、运行批次 `run_id`、合同编码 `contract_code`、尝试轮次 `attempt`、摘要/错误详情。
- **结构化字段**：通过 `LoggerAdapter` 或 `extra` 传入 `run_id`、`contract_code`、`attempt`、`is_progress` 等字段。
- **埋点与汇总**：抓取与转换关键路径加入进度、限流、重试与阶段汇总日志；按 N 条记录周期性输出进度。

## 配置（`config/settings.yaml`）
```yaml
logging:
  level: DEBUG            # 全局最低级别：DEBUG/INFO/WARNING/ERROR
  console: true          # 是否输出到控制台
  console_level: INFO    # 控制台级别，可与文件不同
  json: false            # 文件是否使用 JSON 格式；console 固定简版文本
  progress_interval: 100 # 每处理 N 条输出一次进度

  # 文件命名与运行批次
  naming:
    mode: timestamp                 # timestamp: 文件名包含 run_id
    pattern: "{stage}_{run_id}.log" # 可用变量：{stage}、{run_id}
    run_id_format: "%Y%m%d_%H%M%S"  # 运行批次ID格式

  # 轮转与保留策略
  rotation:
    mode: none          # none | time；none 表示不切分文件
    when: D             # 仅当 mode=time 生效：S/M/H/D/W0-6/MIDNIGHT
    interval: 1
    backup_count: 0     # 0 表示不删除历史（TimedRotating 有效）

  # 日志输出目录（最终文件名由 naming.pattern 生成）
  files:
    pipeline: logs/
    fetch: logs/
    convert: logs/
    transform: logs/
```

## 模块与文件位置
- `feishu_contracts/common/logging_config.py`：初始化与配置 logger/hook/formatter/过滤器。
- `scripts/run_full_pipeline.py`：在读取配置后调用 `init_logging()`，并以 `pipeline` 记录阶段开始/结束与耗时汇总。
- `feishu_contracts/fetch/client.py`：使用 `logging.getLogger("fetch")`；对“合同查询（按编码/分页）”与“合同详情”分别埋点进度、限流、失败原因；关键日志附 `contract_code`/`contract_id`。
- `feishu_contracts/transform/transformer.py`：使用 `logging.getLogger("transform")`；按 sheet 输出统计与耗时。
- `feishu_contracts/convert/jsonl_to_tabular.py`：使用 `logging.getLogger("convert")`；输出读取 JSONL、拆分表、写出 CSV/XLSX 的进度与汇总。

## 控制台输出规范（简版）
- 格式：`HH:MM:SS [stage] message`，`stage` 为 logger 名：`pipeline|fetch|convert|transform`。
- 仅输出关键进度、阶段切换、限流与错误摘要，避免刷屏。

示例：
```
15:06:10 [fetch] 12400/58000 21.4% ok=12190 fail=210 rps=85.3 eta=09:12 cc=HT-2024-00421
15:06:45 [fetch] rate_limited 429 wait=3.2s attempt=2 cc=HT-2024-00421
15:18:33 [convert] start: jsonl→csv/xlsx
15:19:01 [transform] sheet=相对方 out=12430 skip=12 21.4s
15:19:20 [pipeline] done total=14m10s out=output/合同导入模板_填充.xlsx
```

## 文件输出规范（详版/可选 JSON）
- 文本格式建议：`"%(asctime)s [%(levelname)s] [%(name)s] run=%(run_id)s cc=%(contract_code)s cid=%(contract_id)s msg=%(message)s"`
- 可选 JSON 格式：包含 `timestamp`、`level`、`logger`、`run_id`、`contract_code`、`attempt`、`is_progress`、`msg` 等字段。
- 文件名：由 `naming.pattern` 生成（示例：`logs/fetch_20251022_165600.log`、`logs/pipeline_20251022_165600.log`）。
- 保留策略：`rotation.mode=none` 使用 `FileHandler`；`mode=time` 使用 `TimedRotatingFileHandler(..., backupCount=0)`，不按数量自动删除。

示例（文本）：
```
2025-10-22 15:06:10,125 [INFO] [fetch] run=20251022-1505 cc=HT-2024-00421 progress processed=12400 total=58000 ok=12190 fail=210 rps=85.3 eta=552s
2025-10-22 15:06:45,772 [WARNING] [fetch] run=20251022-1505 cc=HT-2024-00421 rate_limit code=429 wait=3.2 attempt=2
2025-10-22 15:19:01,004 [INFO] [transform] run=20251022-1505 sheet=相对方 in=12442 out=12430 skip=12 elapsed=21.4
```

## 埋点清单与字段（全模块规范）
- **通用字段**：
  - `run_id` 本次流水线唯一标识（由 `init_logging` 注入）。
  - `contract_code` 合同编码（按编码查询与下游处理贯穿）。
  - `contract_id` 合同ID（详情阶段与下游表行关联）。
  - `attempt` 当前尝试轮次（限流/重试）。
  - `is_progress` 是否为进度日志（控制台过滤放行）。
  - `sheet` 目标或来源 Sheet 名（转换阶段）。
  - 其他：处理计数（processed/ok/fail）、RPS、ETA、页码/页标识等。

- **pipeline**（`scripts/run_full_pipeline.py`）：
  - 阶段：`[1/3] 抓取`、`[2/3] 转换/填充` 开始/完成与耗时。
  - 汇总：输出路径、总记录数与总耗时；失败时输出错误摘要。

- **fetch/合同查询**（`feishu_contracts/fetch/client.py`）：
  - 按编码查询：
    - DEBUG：`search_by_number start` + `cc`（合同编码）。
    - DEBUG：`search_by_number done items=<N>` + `cc`。
    - WARNING：限流/重试，包含 `code`、`status`、`wait`、`attempt` + `cc`。
  - 分页查询（非按编码）：
    - DEBUG：`search page start token=...`（可脱敏）与 `done items=<N>`（不含 `cc`）。
    - WARNING：限流/重试，包含 `code`、`status`、`wait`、`attempt`（不含 `cc`）。
  - 进度：INFO `progress processed/ok/fail rps eta`，附 `cc` 为最近处理合同编码。
  - 轮次汇总：INFO `round_summary`，统计 ok/fail 与剩余待重试数量。

- **fetch/合同详情**（`feishu_contracts/fetch/client.py`）：
  - DEBUG：每个 `contract_id` 的详情获取 `start/done`（建议新增）。
  - ERROR：详情获取失败，包含 `contract_id`（以及可得的 `contract_code`）。
  - 进度（批量并发时）：每处理 `N` 个 `contract_id` 输出 `progress`，统计成功/失败与RPS（建议新增）。

- **convert（JSONL → CSV/XLSX）**（`feishu_contracts/convert/jsonl_to_tabular.py`）：
  - INFO：`start`：记录 `jsonl/csv/xlsx` 路径与记录数。
  - DEBUG：拆分主键/列表键，列数与各列表键的行计数（建议新增）。
  - INFO：写出 CSV：主表行数；逐列表 Sheet（或 CSV）行数与 Sheet 名。
  - INFO：`done`：输出 `csv/xlsx` 路径与累计写出行数。

- **transform（模板填充）**（`feishu_contracts/transform/transformer.py`）：
  - INFO：`start`：源、模板、映射与输出路径。
  - INFO：每个 `sheet` 结束输出：`sheet`、`policy`、`rows`、`elapsed`。
  - INFO：`done`：最终输出文件与总耗时。

## 初始化与接入
- 在 `scripts/run_full_pipeline.py` 中：
  - 读取 `settings.yaml`，调用 `feishu_contracts/common/logging_config.py` 的 `init_logging(cfg['logging'], PROJ_ROOT)`。
  - 使用 `logging.getLogger("pipeline")` 记录阶段切换与汇总；生成 `run_id` 放入 `LoggerAdapter`。
- 在 `feishu_contracts/fetch/client.py` 中：
  - 使用 `logger = logging.getLogger("fetch")`。
  - 在 `_process_codes_once()` 中累计计数，按 `progress_interval` 输出进度；遇到错误或限流时输出摘要（含 `contract_code`）。
- 在 `feishu_contracts/transform/transformer.py` 中：
  - 使用 `logger = logging.getLogger("transform")`；每个 sheet 完成输出统计与耗时。

## 运行与实时查看
- 运行流水线：`python scripts/run_full_pipeline.py --config config/settings.yaml`
- 实时查看（PowerShell）：
  - `$f = Get-ChildItem .\logs\fetch_*.log | Sort-Object LastWriteTime -Descending | Select-Object -First 1; Get-Content $f.FullName -Wait`
  - `$p = Get-ChildItem .\logs\pipeline_*.log | Sort-Object LastWriteTime -Descending | Select-Object -First 1; Get-Content $p.FullName -Wait`
  - 过滤阶段：`$p = Get-ChildItem .\logs\pipeline_*.log | Sort-Object LastWriteTime -Descending | Select-Object -First 1; Get-Content $p.FullName -Wait | Select-String -Pattern "\[fetch\]"`

## 验收标准（Checklist）
- **[配置]** `logging.level=DEBUG` 时，文件日志包含 DEBUG；控制台仅输出进度/阶段/WARN+。
- **[查询-按编码]** 在 `logs/fetch_*.log` 能看到：`start`/`done items`/`rate_limited` 均含 `cc=<合同编码>`。
- **[查询-分页]** 能看到分页 `DEBUG` 与 `WARNING`（不含 `cc`），并有周期性进度 `INFO`。
- **[详情]** 每个 `contract_id` 的 `start/done` 或失败 `ERROR` 可检索；大批量时有周期性进度 `INFO`（建议实现）。
- **[转换(convert)]** `start`、每表写出行数与 `done` 均可见；空数据路径下能输出空结构。
- **[模板(transform)]** 每个 sheet 的统计可见；最终 `done out=...` 明确。

## 代码改造建议（若尚未实现的埋点）
- **fetch/详情**：在 `FeishuContractClient.fetch_all_details()` 中为每个 `contract_id` 增加 `DEBUG start/done` 与失败 `ERROR`，可在调用处透传 `contract_code` 作为 `extra`。
- **convert**：在 `convert_jsonl()` 内加入 `logger = logging.getLogger("convert")`，输出 `start/done` 与列表表计数；大数据量时可每写出一万行进度一次。
- **transform**：如需更细粒度，可在 `process_one_to_one/process_simple_append` 增加批量进度 `INFO`，每处理 N 行输出一次（受 `progress_interval` 控制）。

## 监控指标与建议
- **RPS（每秒处理量）**、**ETA（预计剩余时间）**：进度日志中持续输出。
- **降噪策略**：规模极大时，将单条失败降为 `DEBUG`，仅保留进度与汇总为 `INFO`。
- **日志留存**：根据磁盘规划 `backup_count`；必要时可切换为按天轮转（`TimedRotatingFileHandler`）。

## 实施步骤（建议）
1. 新增 `feishu_contracts/common/logging_config.py`，实现初始化、格式化与过滤器。
2. 在 `config/settings.yaml` 添加 `logging` 段（见上）。
3. 接入 `scripts/run_full_pipeline.py`：初始化日志与阶段汇总。
4. 接入 `feishu_contracts/fetch/client.py`：进度/限流/失败与轮次汇总埋点，贯穿 `contract_code`。
5. 接入 `feishu_contracts/transform/transformer.py` 与（可选）`convert`：输出 sheet 级统计与总耗时。
6. 验证：大批量跑一次，观察控制台与文件日志，确认读者可在 10s 内判断进度、瓶颈与异常位置。

## 回滚策略
- 通过 `settings.yaml` 关闭 `console` 或调高 `console_level` 即可降噪。
- 保留原有 `feishu_contracts/common/logging.py` 能力；如需，可切回旧 `setup_logger()`。

## 附录：示例日志片段
- 控制台：
```
15:06:10 [fetch] 12400/58000 21.4% ok=12190 fail=210 rps=85.3 eta=09:12 cc=HT-2024-00421
15:06:45 [fetch] rate_limited 429 wait=3.2s attempt=2 cc=HT-2024-00421
15:19:20 [pipeline] done total=14m10s out=output/合同导入模板_填充.xlsx
```
- 文件：
```
2025-10-22 15:06:10,125 [INFO] [fetch] run=20251022-1505 cc=HT-2024-00421 progress processed=12400 total=58000 ok=12190 fail=210 rps=85.3 eta=552s
2025-10-22 15:06:45,772 [WARNING] [fetch] run=20251022-1505 cc=HT-2024-00421 rate_limit code=429 wait=3.2 attempt=2
2025-10-22 15:19:01,004 [INFO] [transform] run=20251022-1505 sheet=相对方 in=12442 out=12430 skip=12 elapsed=21.4
```
